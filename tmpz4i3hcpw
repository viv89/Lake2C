# -*- coding: utf-8 -*-
"""
Created on Mon May  9 14:39:01 2022

@author: vija
"""

import pandas as pd
from funcs.io import read_data, run_validation, read_lake_props, heatmap, plot_profiles
from modules.physics2 import lake


lake_name = 'greifensee'   #either geneva, greifensee or feeagh for validation and plotting

#%% Read inputs
lake_fname      = 'input/' + lake_name + '.txt'
# lake_fname      = 'input/shallow_lake_1.txt'
weather_file    = 'input/NEST2.epw' # 'input/CHE_ZH_Dubendorf.AP.066099_TMYx.epw'  'input/Zuerich_Fluntern-hour.epw' #'C:/Users/vija/Documents/Data/weather/meteo/EE/current/Tartu-hour.epw'
profiles_file   = 'input/demand_' + lake_name + '.xlsx' 

#%% Boundary conditions 
data,info = read_data(weather_file, profiles_file)
n_years = 5
data = pd.concat([data]*n_years)

#%% Lake data
lake_props = read_lake_props(lake_fname)
lake_props['wtemp_init'] = 7.0        # this will likely be changed according to climate
lake_props['latitude']   = info['latitude']   # is this already inside lake_props? (see lake.txt)

#%%
params = {'nt'  : len(data.index),
          'dt'  : 3600*6,  # 1 time-step = seconds per day
          'n_years': n_years}

properties = {'g'    : 9.81,  # gravity acceleration (m/s2)
              'rho_0': 998.2, # ref water density (kg/m3)
              'cp'   : 4183,  # specific heat J/(kg K)
              'alpha': 0.13}  # diffuse reflection of solar radiation (albedo) mean annual value given by Cogley, 1979)

#%% Run lake model

lk = lake(lake_props, params, properties) # Initialize lake object
lk.run(data, False) # Run lake model without exchange
simout = lk.hist

#%%
simout.index = pd.date_range(start='1/1/2019', periods=1460, freq='6H')   
simout = simout.resample('D').mean()

#%%
# Re-run lake model with exchange
lk = lake(lake_props, params, properties) # Re-initialize lake object
lk.run(data, True)
# Save modified temperature profiles
simout['Tw_e_mod'] = lk.hist['Tw_e']
# simout['Tw_t_mod'] = lk.hist['Tw_t']
simout['Tw_h_mod'] = lk.hist['Tw_h']
# Temperature differences
simout['delta_Tw_e'] = simout['Tw_e_mod'] - simout['Tw_e']
# simout['delta_Tw_t'] = simout['Tw_t_mod'] - simout['Tw_t']
simout['delta_Tw_h'] = simout['Tw_h_mod'] - simout['Tw_h']

# min(simout['delta_Tw_t'])

#%% Validate model
vdata, errors = run_validation(lake_name, simout)

#%% Plot graphs 
heatmap(lake_name, simout)       # available for all lakes
plot_profiles(lake_name, vdata)  # now available for geneva, greifensee and feeagh


